<!DOCTYPE html>
<html lang="ka">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodeVault - გააზიარე შენი კოდი მარტივად</title>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-[Inter]">

  <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
      <a href="#" class="text-2xl font-bold flex items-center">
        <span class="material-icons mr-2">code</span> CodeVault
      </a>
      <nav class="flex gap-2">
        <button id="dashboard-btn" class="hidden bg-white text-blue-700 px-3 py-1 rounded-full">დაფა</button>
        <button id="login-btn" class="bg-blue-500 px-3 py-1 rounded-full">შესვლა</button>
        <button id="register-btn" class="bg-green-500 px-3 py-1 rounded-full">რეგისტრაცია</button>
        <button id="logout-btn" class="hidden bg-red-500 px-3 py-1 rounded-full">გასვლა</button>
      </nav>
    </div>
  </header>

  <main id="app-content" class="container mx-auto p-6"></main>

  <footer class="bg-gray-800 text-white text-center text-sm py-3">&copy; 2025 CodeVault</footer>

  <!-- Auth Modal -->
  <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md relative">
      <button id="close-auth-modal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">
        <span class="material-icons">close</span>
      </button>
      <h2 id="auth-modal-title" class="text-2xl font-bold text-center mb-4">შესვლა</h2>
      <form id="auth-form" class="space-y-3">
        <input type="email" id="email" placeholder="ელფოსტა" required class="w-full border p-2 rounded">
        <input type="password" id="password" placeholder="პაროლი" required class="w-full border p-2 rounded">
        <p id="auth-error" class="text-red-600 text-center hidden"></p>
        <button type="submit" id="auth-submit-btn" class="bg-indigo-600 w-full text-white py-2 rounded">შესვლა</button>
        <p class="text-center text-sm">
          <button type="button" id="toggle-auth-mode" class="text-indigo-600 hover:underline">არ გაქვთ ანგარიში? დარეგისტრირდით</button>
        </p>
      </form>
    </div>
  </div>

  <!-- Script Modal -->
  <div id="script-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl relative">
      <button id="close-script-modal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">
        <span class="material-icons">close</span>
      </button>
      <h2 id="script-modal-title" class="text-2xl font-bold mb-4 text-center">ახალი სკრიპტი</h2>
      <form id="script-form" class="space-y-3">
        <input type="text" id="script-title" placeholder="სკრიპტის სათაური" required class="w-full border p-2 rounded">
        <textarea id="script-content" rows="10" placeholder="<div>მარტივი სკრიპტი</div>" required class="w-full border p-2 rounded font-mono bg-gray-900 text-green-300"></textarea>
        <p id="script-error" class="text-red-600 text-center hidden"></p>
        <button type="submit" class="bg-blue-600 text-white py-2 rounded w-full">შენახვა</button>
      </form>
    </div>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyAB2FnGzm-vRFzjzMFc5fSqIx4JFhtSZHg",
      authDomain: "hostsite-87e89.firebaseapp.com",
      projectId: "hostsite-87e89",
      storageBucket: "hostsite-87e89.firebasestorage.app",
      messagingSenderId: "594577784773",
      appId: "1:594577784773:web:16b148cc0bc00999ebd5ac"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const APP_ARTIFACT_ID = "CodeVault_App";

    const appContent = document.getElementById('app-content');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const dashboardBtn = document.getElementById('dashboard-btn');

    const authModal = document.getElementById('auth-modal');
    const closeAuthModal = document.getElementById('close-auth-modal');
    const authForm = document.getElementById('auth-form');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const authError = document.getElementById('auth-error');
    const authModalTitle = document.getElementById('auth-modal-title');
    const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
    const authSubmitBtn = document.getElementById('auth-submit-btn');

    const scriptModal = document.getElementById('script-modal');
    const closeScriptModal = document.getElementById('close-script-modal');
    const scriptForm = document.getElementById('script-form');
    const scriptTitle = document.getElementById('script-title');
    const scriptContent = document.getElementById('script-content');
    const scriptError = document.getElementById('script-error');

    let currentUser = null;
    let currentAuthMode = 'login';
    let editingScriptId = null;

    auth.onAuthStateChanged((user) => {
      currentUser = user;
      updateNav();
      handleRoute();
    });

    function updateNav() {
      if (currentUser) {
        loginBtn.classList.add('hidden');
        registerBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        dashboardBtn.classList.remove('hidden');
      } else {
        loginBtn.classList.remove('hidden');
        registerBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        dashboardBtn.classList.add('hidden');
      }
    }

    function showModal(modal) {
      modal.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    }
    function hideModal(modal) {
      modal.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
    }

    // ---------- ROUTER ----------
    window.addEventListener('hashchange', handleRoute);
    function handleRoute() {
      const hash = window.location.hash;
      if (hash.startsWith('#/script/')) {
        renderPublicScript(hash.split('/script/')[1]);
      } else if (hash === '#/dashboard') {
        currentUser ? renderDashboard() : showModal(authModal);
      } else {
        renderHome();
      }
    }

    function renderHome() {
      appContent.innerHTML = `
        <section class="text-center py-16">
          <h1 class="text-4xl font-extrabold mb-4">გააზიარე შენი კოდი მარტივად</h1>
          <p class="text-gray-600 mb-6">შეინახე, გაუზიარე და გაუშვი შენი HTML/JS სკრიპტები სწრაფად.</p>
          <button id="get-started" class="bg-indigo-600 text-white px-6 py-2 rounded-full">დაიწყე ახლავე</button>
        </section>
      `;
      document.getElementById('get-started').onclick = () => {
        currentUser ? window.location.hash = '#/dashboard' : showModal(authModal);
      };
    }

    async function renderDashboard() {
      appContent.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-3xl font-bold">ჩემი სკრიპტები</h2>
          <button id="new-script" class="bg-indigo-600 text-white px-4 py-2 rounded-full">ახალი სკრიპტი</button>
        </div>
        <div id="scripts" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      `;

      document.getElementById('new-script').onclick = () => {
        editingScriptId = null;
        scriptForm.reset();
        showModal(scriptModal);
      };

      const scriptsContainer = document.getElementById('scripts');
      const scriptsRef = db.collection('artifacts').doc(APP_ARTIFACT_ID)
        .collection('users').doc(currentUser.uid)
        .collection('scripts');

      const snapshot = await scriptsRef.orderBy('createdAt', 'desc').get();
      scriptsContainer.innerHTML = snapshot.empty
        ? `<p class="text-gray-500 col-span-full text-center">ჯერ არ გაქვთ სკრიპტები.</p>`
        : snapshot.docs.map(doc => {
          const d = doc.data();
          return `
            <div class="bg-white p-4 rounded-lg shadow">
              <h3 class="text-xl font-semibold">${d.title}</h3>
              <div class="text-sm text-gray-500">${new Date(d.createdAt).toLocaleDateString('ka-GE')}</div>
              <div class="flex gap-2 mt-3">
                <button onclick="window.location.hash='#/script/${d.publicId}'" class="bg-blue-500 text-white px-2 py-1 rounded">ნახვა</button>
                <button onclick="editScript('${doc.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded">რედაქტირება</button>
                <button onclick="deleteScript('${doc.id}')" class="bg-red-500 text-white px-2 py-1 rounded">წაშლა</button>
              </div>
            </div>`;
        }).join('');
    }

    async function renderPublicScript(id) {
      appContent.innerHTML = `<p class="text-center text-gray-600 py-8">იტვირთება...</p>`;
      try {
        const q = await db.collectionGroup('scripts').where('publicId', '==', id).get();
        if (q.empty) {
          appContent.innerHTML = `<p class="text-center text-red-600 py-8">სკრიპტი ვერ მოიძებნა ან წაშლილია.</p>`;
          return;
        }
        const d = q.docs[0].data();
        appContent.innerHTML = `
          <div class="max-w-4xl mx-auto py-6">
            <h2 class="text-3xl font-bold mb-2">${d.title}</h2>
            <p class="text-sm text-gray-500 mb-4">${d.ownerEmail} • ${new Date(d.createdAt).toLocaleDateString('ka-GE')}</p>
            <pre class="bg-gray-900 text-green-300 p-4 rounded overflow-auto font-mono">${d.content.replace(/[<>&]/g, c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]))}</pre>
            <h3 class="text-xl font-semibold mt-6 mb-2">შესრულების შედეგი:</h3>
            <iframe class="w-full h-80 border rounded" sandbox="allow-scripts allow-same-origin"></iframe>
          </div>`;
        const iframe = appContent.querySelector('iframe');
        iframe.contentDocument.open();
        iframe.contentDocument.write(d.content);
        iframe.contentDocument.close();
      } catch (e) {
        appContent.innerHTML = `<p class="text-red-600 text-center">${e.message}</p>`;
      }
    }

    async function editScript(id) {
      const ref = db.collection('artifacts').doc(APP_ARTIFACT_ID)
        .collection('users').doc(currentUser.uid)
        .collection('scripts').doc(id);
      const doc = await ref.get();
      if (doc.exists) {
        const d = doc.data();
        editingScriptId = id;
        scriptTitle.value = d.title;
        scriptContent.value = d.content;
        showModal(scriptModal);
      }
    }

    async function deleteScript(id) {
      if (!confirm("წავშალო ეს სკრიპტი?")) return;
      await db.collection('artifacts').doc(APP_ARTIFACT_ID)
        .collection('users').doc(currentUser.uid)
        .collection('scripts').doc(id).delete();
      alert('წაიშალა');
      renderDashboard();
    }

    scriptForm.onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      const title = scriptTitle.value.trim();
      const content = scriptContent.value.trim();
      if (!title || !content) return alert('ყველა ველი აუცილებელია');

      const ref = db.collection('artifacts').doc(APP_ARTIFACT_ID)
        .collection('users').doc(currentUser.uid)
        .collection('scripts');

      if (editingScriptId) {
        await ref.doc(editingScriptId).update({ title, content, updatedAt: new Date().toISOString() });
      } else {
        const newDoc = await ref.add({
          title, content,
          ownerId: currentUser.uid,
          ownerEmail: currentUser.email,
          createdAt: new Date().toISOString()
        });
        await newDoc.update({ publicId: newDoc.id });
      }
      hideModal(scriptModal);
      renderDashboard();
    };

    // --- Auth Modal Logic ---
    loginBtn.onclick = () => { currentAuthMode = 'login'; updateAuthUI(); showModal(authModal); };
    registerBtn.onclick = () => { currentAuthMode = 'register'; updateAuthUI(); showModal(authModal); };
    closeAuthModal.onclick = () => hideModal(authModal);
    closeScriptModal.onclick = () => hideModal(scriptModal);
    logoutBtn.onclick = () => auth.signOut();

    toggleAuthModeBtn.onclick = () => {
      currentAuthMode = currentAuthMode === 'login' ? 'register' : 'login';
      updateAuthUI();
    };

    function updateAuthUI() {
      authError.classList.add('hidden');
      if (currentAuthMode === 'login') {
        authModalTitle.textContent = 'შესვლა';
        authSubmitBtn.textContent = 'შესვლა';
        toggleAuthModeBtn.textContent = 'არ გაქვთ ანგარიში? დარეგისტრირდით';
      } else {
        authModalTitle.textContent = 'რეგისტრაცია';
        authSubmitBtn.textContent = 'რეგისტრაცია';
        toggleAuthModeBtn.textContent = 'უკვე გაქვთ ანგარიში? შედით';
      }
    }

    authForm.onsubmit = async (e) => {
      e.preventDefault();
      authError.classList.add('hidden');
      try {
        if (currentAuthMode === 'login') {
          await auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value);
        } else {
          await auth.createUserWithEmailAndPassword(emailInput.value, passwordInput.value);
        }
        hideModal(authModal);
      } catch (err) {
        authError.textContent = err.message;
        authError.classList.remove('hidden');
      }
    };

    // Start
    handleRoute();
  </script>
</body>
</html>
